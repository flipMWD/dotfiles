#!/usr/bin/env bash

# User variables
bkp_dir="${XDG_DOCUMENTS_DIR:-$HOME/Documents}/backup"
if [[ ! -d "$bkp_dir" ]]; then
	echo -e "Backup Directory does not exist:\n$bkp_dir"
	exit 1
fi

bkp_list="$bkp_dir/1_backup_list"
if [[ ! -f "$bkp_list" ]]; then
	echo "Backup List could not be found."
	exit 101
fi

date_dir="bkp_system_$(date -I)"
if [[ ! -d "$bkp_dir/$date_dir" ]]; then
	mkdir -p "$bkp_dir/$date_dir"
fi

# Copy all files and directories in backup_list to date_dir
while IFS='' read -r line; do
	case "$line" in
		''|\#*) continue ;;
	esac
	mkdir -p "$bkp_dir/$date_dir/${line%/*}"
	eval cp -ru "$line" '"$bkp_dir/$date_dir/${line%/*}"'
done < "$bkp_list"

# List explicitly installed packages
dnf repoquery --userinstalled > "$bkp_dir/$date_dir/system-installed-pkgs"

# Copy list with full paths
cp -u "$bkp_list" "$bkp_dir/$date_dir"

# Archive and compact
tar -C "$bkp_dir" -czf "$bkp_dir/$date_dir.tgz" "$date_dir"

# Clean temp directory
rm -rf "$bkp_dir/$date_dir"
