#!/bin/sh

help_fn() {
	echo "Usage:
	--create <RAW|QCOW2> [<SIZE>]G
	--install <ISO> <RAW|QCOW2>
	--run <RAW|QCOW2>
Options:
	qemu-img create -f <FMT> <PATH> <SIZE>G
	qemu-system-x86_64
		-enable-kvm
		-smp <CORES>
		-m <MEM>G
		-device intel-hda -device hda-duplex
		[-cdrom <PATH> -boot menu=on]
		-drive \"file=<PATH>,format=<FMT>\""
}

case "$1" in
	--create|-c)
		shift
		[ -d "${1%/*}" ] || mkdir -p "${1%/*}" 
		qemu-img create -f "${1##*.}" "$1" "${2:-30}G"
		exit 0
		;;
	--install|-i)
		shift
		install="-cdrom $1 -boot menu=on"
		shift
		disk_path="$1"
		;;
	--run|-r)
		shift
		disk_path="$1"
		;;
	*)
		help_fn
		exit 1
esac

exec qemu-system-x86_64 \
	-enable-kvm \
	-smp 2 \
	-m 4G \
	-device intel-hda -device hda-duplex \
	$install \
	-drive "file=${disk_path},format=raw"
